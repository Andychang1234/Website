<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æƒ…ä¾¶å…±åŒè¨˜è³¬æœ¬ï¼ˆå‹•æ¼«é¢¨ï¼‰</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;800&family=Baloo+2:wght@600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fff6fb;
      --panel:#ffffffcc;
      --primary:#ff71a6;   /* ç²‰ç´… */
      --primary-2:#ff9cc3; /* ç²‰ç´…äº® */
      --accent:#7dd3fc;    /* å¤©è— */
      --mint:#86efac;      /* è–„è· */
      --lav:#c7b8ff;       /* æ·¡ç´« */
      --ink:#412e4d;
      --muted:#6a5b73;
      --chip:#ffe4ef;
      --danger:#ef4444;
      --good:#16a34a;
      --card:#fff0f6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 1200px at 20% -10%, #ffe6f4 0%, #fff6fb 40%, #ffffff 75%),
                  radial-gradient(900px 900px at 120% 10%, #eaf6ff 0%, #fff 60%);
      font-family: 'Nunito', system-ui, -apple-system, "Segoe UI", Roboto, "PingFang HK", "Noto Sans CJK", sans-serif;
      color:var(--ink);
      overflow-x:hidden;
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(8px);
      background: #ffffffaa;
      border-bottom: 2px dashed #ffd1e5;
    }
    .wrap{max-width:1000px;margin:0 auto;padding:12px 16px}
    .brand{
      display:flex;align-items:center;gap:12px;
    }
    .brand .logo{
      width:42px;height:42px;border-radius:50%;
      background: conic-gradient(from 210deg, var(--primary), var(--accent), var(--lav), var(--primary));
      position:relative; box-shadow:0 6px 16px #ff71a62a;
    }
    .brand .logo::after{
      content:"â¤"; position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      color:white; font-size:20px; text-shadow:0 1px 3px #00000030;
    }
    h1{font-family:"Baloo 2", cursive; margin:0; font-size:22px; letter-spacing:0.3px}
    .sub{color:var(--muted); font-size:13px; margin-top:-2px}
    .tabs{margin-top:10px; display:flex; gap:8px; flex-wrap:wrap}
    .tab{
      background:var(--chip); color:#7a2a49;
      border:2px solid #ffc2dd; padding:8px 12px; border-radius:999px; cursor:pointer; user-select:none;
      font-weight:800; transition:.2s; font-size:14px;
    }
    .tab.active{ background:var(--primary); border-color:#ff9cc3; color:white; box-shadow:0 6px 14px #ff71a62d }
    .grid{
      display:grid; gap:16px; grid-template-columns: 1fr;
    }
    @media(min-width:860px){
      .grid{ grid-template-columns: 1.2fr 1fr }
    }
    .panel{
      background:var(--panel);
      border:2px dashed #ffd3e7;
      border-radius:18px; padding:16px;
      box-shadow:0 12px 30px #ff6fab1c;
      position:relative; overflow:hidden;
    }
    .panel h3{
      margin:0 0 10px 0; font-size:18px; font-family:"Baloo 2"; color:#7a3253;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1 1 160px}
    label{font-weight:800; font-size:13px; color:#6f2c4d}
    input, select{
      width:100%; padding:12px 12px; border-radius:12px;
      border:2px solid #ffd3e7; background:#fff; font-size:14px;
      outline:none; transition:.2s;
    }
    input:focus, select:focus{ border-color:var(--primary); box-shadow:0 6px 14px #ff71a61d }
    .btn{
      background:var(--primary); color:white; border:none; padding:10px 14px; border-radius:12px;
      font-weight:800; cursor:pointer; box-shadow:0 8px 18px #ff71a633;
      transition:.15s; font-size:14px;
    }
    .btn.alt{ background:var(--accent); color:#123a53 }
    .btn.ghost{ background:#fff; color:#7a2a49; border:2px solid #ffc2dd }
    .btn.danger{ background:var(--danger) }
    .chip{
      display:inline-flex; align-items:center; gap:8px; background:var(--card);
      padding:8px 10px; border-radius:12px; border:2px dashed #ffc8dd; font-weight:800; color:#7a2a49; font-size:13px;
    }
    .balance{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .balance .num{ font-size:28px; font-weight:800 }
    .balance.negative .num{ color:var(--danger) }
    .notice{
      background:#fff3f5; border:2px dashed #ffb8cc; color:#7a2a49; border-radius:14px; padding:10px 12px; font-weight:800; font-size:13px;
    }
    .list{ display:flex; flex-direction:column; gap:10px; max-height:380px; overflow:auto; padding-right:4px }
    .item{
      background:#fff; border:2px dashed #ffd3e7; border-radius:14px; padding:10px 12px;
      display:grid; grid-template-columns: 1fr auto; gap:6px; align-items:center;
    }
    .item .meta{ font-size:12px; color:#8b6a86 }
    .item .amt{ font-weight:900 }
    .pill{ display:inline-block; padding:4px 8px; border-radius:999px; background:#ffe4ef; font-size:12px; font-weight:800; color:#7a2a49 }
    .sum-row{ display:flex; justify-content:space-between; gap:10px; padding:6px 4px; font-weight:800; color:#6a5b73 }
    .chart{
      display:flex; gap:10px; align-items:flex-end; padding:10px; border-radius:14px; background:#fff; border:2px dashed #ffd3e7; min-height:120px;
    }
    .bar{ width:28px; background:linear-gradient(180deg, var(--primary-2), var(--primary)); border-radius:10px 10px 0 0; position:relative }
    .bar label{ position:absolute; bottom:100%; transform:translateY(-6px); font-size:12px; font-weight:900; color:#7a2a49; white-space:nowrap }
    .footer{font-size:12px; color:#a28aa8; text-align:center; padding:30px 0}
    /* æ¼«ç•«è§’è‰²èƒŒæ™¯ï¼ˆå¯æ›åœ–ï¼‰ */
    .bg-fig{
      position:fixed; inset:0; pointer-events:none; z-index:-1; overflow:hidden;
    }
    .fig{
      position:absolute; opacity:.10; filter: blur(0px) saturate(1.1);
      background-size:contain; background-repeat:no-repeat; background-position:center;
    }
    /* ä»¥ emoji æš«ä»£è§’è‰²å‰ªå½±ï¼Œå¯æ›æˆæœ¬åœ° PNG/SVGï¼šbackground-image:url('./your-image.png') */
    .fig.a{ left:-4%; bottom:-2%; width:46vmin; height:46vmin; background-image:linear-gradient(#ffc0da, #ffd9e9); mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="500" height="500"><text x="0" y="400" font-size="380">ğŸ§‘â€ğŸ¤</text></svg>') center/contain no-repeat; -webkit-mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="500" height="500"><text x="0" y="400" font-size="380">ğŸ§‘â€ğŸ¤</text></svg>') center/contain no-repeat; }
    .fig.b{ right:-6%; top:-4%; width:54vmin; height:54vmin; background-image:linear-gradient(#a8ddff, #d7f1ff); mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="500" height="500"><text x="0" y="400" font-size="380">ğŸ§œâ€â™€ï¸</text></svg>') center/contain no-repeat; -webkit-mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="500" height="500"><text x="0" y="400" font-size="380">ğŸ§œâ€â™€ï¸</text></svg>') center/contain no-repeat; }
    /* æ¼‚æµ®æ³¡æ³¡ */
    .bubble{
      position:fixed; border-radius:50%; opacity:.18; z-index:-1; animation: float 8s ease-in-out infinite;
      background: radial-gradient(circle at 30% 30%, #fff, #ffd9ec 60%, #ffc2dd 100%);
      box-shadow: inset 0 0 30px #ffffffcc;
    }
    .bubble:nth-child(1){ width:120px;height:120px; left:10%; top:70%; animation-delay:-2s}
    .bubble:nth-child(2){ width:180px;height:180px; left:40%; top:78%; animation-delay:-3s}
    .bubble:nth-child(3){ width:90px;height:90px; left:75%; top:72%; animation-delay:-5s}
    @keyframes float {
      0%,100%{ transform:translateY(0) }
      50%{ transform:translateY(-18px) }
    }
    .helper{font-size:12px; color:#8b6a86}
    .inline{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .tiny{font-size:11px}
  </style>
</head>
<body>
  <div class="bg-fig">
    <div class="fig a"></div>
    <div class="fig b"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
  </div>

  <header>
    <div class="wrap">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>æƒ…ä¾¶å…±åŒè¨˜è³¬æœ¬</h1>
          <div class="sub">å‹•æ¼«å¡é€šé¢¨ãƒ»ç¨ç«‹å¹£ç¨®è³¬æœ¬ãƒ»å…±åŒè³‡é‡‘æ± ãƒ»è¶…æ”¯æé†’</div>
        </div>
      </div>
      <div class="tabs" id="tabs">
        <div class="tab active" data-tab="spend">æ–°å¢èŠ±è²»</div>
        <div class="tab" data-tab="topup">æ¹ŠéŒ¢åŠ å€¼</div>
        <div class="tab" data-tab="records">ç´€éŒ„ç¸½è¦½</div>
        <div class="tab" data-tab="analysis">æœˆåº¦åˆ†æ</div>
        <div class="tab" data-tab="settings">è¨­å®šèˆ‡å‚™ä»½</div>
      </div>
    </div>
  </header>

  <main class="wrap" style="padding-top:12px; padding-bottom:30px;">
    <section id="spend" class="grid view">
      <div class="panel">
        <h3>æ–°å¢èŠ±è²»</h3>
        <div class="row">
          <div>
            <label>å¹£ç¨®</label>
            <select id="currencySpend"></select>
          </div>
          <div>
            <label>é¡åˆ¥</label>
            <div class="inline">
              <select id="category"></select>
              <button class="btn ghost" id="addCategoryBtn">ï¼‹æ–°å¢é¡åˆ¥</button>
            </div>
            <div class="helper tiny">é è¨­é¡åˆ¥å¯ç”¨ï¼Œä¹Ÿå¯è‡ªè¨‚æ–°å¢ï¼›æœªä¾†å¯å†å¢åŠ ã€‚</div>
          </div>
        </div>
        <div class="row">
          <div>
            <label>åç¨±</label>
            <input id="name" placeholder="ä¾‹å¦‚ï¼šæ™šé¤ã€é›»å½±ç¥¨ã€å¥¶èŒ¶" />
          </div>
          <div>
            <label>é‡‘é¡</label>
            <input id="amount" type="number" step="0.01" placeholder="ä¾‹å¦‚ï¼š120" />
          </div>
        </div>
        <div class="inline" style="margin-top:6px">
          <button class="btn" id="addSpend">åŠ å…¥èŠ±è²»</button>
          <div class="helper">å°è²¼å£«ï¼šèŠ±è²»æœƒç›´æ¥å¾è©²å¹£ç¨®çš„è³‡é‡‘æ± æ‰£é™¤ã€‚</div>
        </div>
      </div>

      <div class="panel">
        <h3>è³‡é‡‘æ± ç‹€æ…‹</h3>
        <div class="row">
          <div>
            <label>é¸æ“‡å¹£ç¨®</label>
            <select id="currencyBalance"></select>
          </div>
        </div>
        <div id="balanceBox" class="balance" style="margin-top:8px">
          <span class="chip">å…±åŒè³‡é‡‘æ± </span>
          <span class="num" id="balanceNum">0</span>
        </div>
        <div id="negNotice" class="notice" style="display:none; margin-top:10px">
          âš ï¸ è³‡é‡‘æ± ç‚ºè² æ•¸ï¼Œè¡¨ç¤ºéœ€è¦ã€Œæ¹ŠéŒ¢ã€è£œè¶³å–”ï¼
        </div>
      </div>
    </section>

    <section id="topup" class="grid view" style="display:none">
      <div class="panel">
        <h3>æ¹ŠéŒ¢åŠ å€¼</h3>
        <div class="row">
          <div>
            <label>å¹£ç¨®</label>
            <select id="currencyTopup"></select>
          </div>
          <div>
            <label>é‡‘é¡</label>
            <input id="topupAmount" type="number" step="0.01" placeholder="ä¾‹å¦‚ï¼š200" />
          </div>
          <div>
            <label>å‚™è¨»ï¼ˆå¯é¸ï¼‰</label>
            <input id="topupNote" placeholder="ä¾‹å¦‚ï¼šæœ¬æœˆè£œè²¼ã€ç”Ÿæ—¥åŸºé‡‘â€¦" />
          </div>
        </div>
        <div class="inline" style="margin-top:6px">
          <button class="btn alt" id="addTopup">åŠ å…¥æ¹ŠéŒ¢</button>
          <div class="helper">åŠ å€¼å¾Œï¼Œè©²å¹£ç¨®è³‡é‡‘æ± æœƒå¢åŠ ã€‚</div>
        </div>
      </div>

      <div class="panel">
        <h3>å¿«é€ŸæŸ¥çœ‹è³‡é‡‘æ± </h3>
        <div class="row">
          <div>
            <label>å¹£ç¨®</label>
            <select id="currencyQuick"></select>
          </div>
        </div>
        <div class="balance" id="quickBalance" style="margin-top:8px">
          <span class="chip">å…±åŒè³‡é‡‘æ± </span>
          <span class="num" id="quickBalanceNum">0</span>
        </div>
      </div>
    </section>

    <section id="records" class="view" style="display:none">
      <div class="panel">
        <h3>ç´€éŒ„ç¸½è¦½</h3>
        <div class="row">
          <div>
            <label>å¹£ç¨®</label>
            <select id="currencyRecords"></select>
          </div>
          <div>
            <label>æœˆä»½</label>
            <input id="recordsMonth" type="month" />
          </div>
          <div>
            <label>é¡å‹</label>
            <select id="recordsType">
              <option value="all">å…¨éƒ¨</option>
              <option value="spend">èŠ±è²»</option>
              <option value="topup">æ¹ŠéŒ¢</option>
            </select>
          </div>
        </div>
        <div class="list" id="recordsList" style="margin-top:10px"></div>
      </div>
    </section>

    <section id="analysis" class="view" style="display:none">
      <div class="panel">
        <h3>æœˆåº¦åˆ†æ</h3>
        <div class="row">
          <div>
            <label>å¹£ç¨®</label>
            <select id="currencyAnalysis"></select>
          </div>
          <div>
            <label>æœˆä»½</label>
            <input id="analysisMonth" type="month" />
          </div>
        </div>
        <div id="analysisBox" style="margin-top:12px">
          <div class="sum-row"><span>ç¸½èŠ±è²»</span><span id="sumTotal">0</span></div>
          <div class="sum-row"><span>å¹³å‡æ¯æ—¥èŠ±è²»</span><span id="avgPerDay">0</span></div>
          <div class="sum-row"><span>Top 3 é¡åˆ¥</span><span id="top3">â€”</span></div>
          <div style="margin-top:10px">
            <div class="chip">å„é¡åˆ¥èŠ±è²»ï¼ˆé•·æ¢åœ–ï¼‰</div>
            <div class="chart" id="chart"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="settings" class="grid view" style="display:none">
      <div class="panel">
        <h3>é¡åˆ¥èˆ‡å¹£ç¨®</h3>
        <div class="row">
          <div>
            <label>ç¾æœ‰é¡åˆ¥</label>
            <div id="categoryList" class="list" style="max-height:180px"></div>
          </div>
          <div>
            <label>æ–°å¢é¡åˆ¥</label>
            <div class="inline">
              <input id="newCategoryName" placeholder="ä¾‹å¦‚ï¼šæ—…éŠã€äº¤é€šâ€¦" />
              <button class="btn" id="saveCategory">æ–°å¢</button>
            </div>
          </div>
        </div>
        <hr style="border:none; border-top:2px dashed #ffd3e7; margin:16px 0">
        <div class="row">
          <div>
            <label>ç¾æœ‰å¹£ç¨®</label>
            <div id="currencyList" class="list" style="max-height:180px"></div>
          </div>
          <div>
            <label>æ–°å¢å¹£ç¨®</label>
            <div class="inline">
              <input id="newCurrencyCode" placeholder="ä¾‹å¦‚ï¼šTWDã€USDâ€¦" />
              <button class="btn alt" id="saveCurrency">æ–°å¢å¹£ç¨®</button>
            </div>
            <div class="helper tiny">æ¯å€‹å¹£ç¨®æœƒæœ‰ç¨ç«‹çš„è³‡é‡‘æ± èˆ‡ç´€éŒ„ã€‚</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <h3>è³‡æ–™å‚™ä»½èˆ‡å®‰å…¨</h3>
        <div class="inline">
          <button class="btn ghost" id="exportBtn">åŒ¯å‡ºå…¨éƒ¨è³‡æ–™</button>
          <input id="importFile" type="file" accept="application/json" style="display:none" />
          <button class="btn ghost" id="importBtn">åŒ¯å…¥è³‡æ–™</button>
          <button class="btn danger" id="resetBtn">æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
        </div>
        <div class="helper" style="margin-top:8px">
          åŒ¯å‡ºæœƒä¸‹è¼‰ä¸€å€‹ JSON æª”ï¼Œå¯ç•™ä½œå‚™ä»½ï¼›åŒ¯å…¥æœƒè¦†è“‹ç¾æœ‰è³‡æ–™ï¼ˆè«‹å°å¿ƒï¼‰ã€‚
        </div>
      </div>
    </section>
  </main>

  <div class="footer">â¤ ç¥ä½ å€‘ç”œç”œèœœèœœï¼Œæ¯ä¸€ç­†éƒ½è¨˜ä¸‹å…±åŒçš„æ—¥å¸¸</div>

  <script>
    // åˆå§‹è³‡æ–™
    const DEFAULT_CATEGORIES = ["æ­£é¤","å®¶é•·èšé¤","æœ‹å‹èšé¤","å°é£Ÿ","ç”œå“","æ‰‹æ–é£²å“","å…¶ä»–é£²å“","å¨›æ¨‚","ç©å…·","å…¶ä»–"];
    const DEFAULT_CURRENCIES = ["HKD","CNY","JPY"];
    const LS_KEY = "couple_ledger_v1";

    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>document.querySelectorAll(s);

    const state = {
      categories: [],
      currencies: [],
      books: {}, // { HKD: { balance:0, tx:[{id,type,ts,category,name,amount}] }, ... }
    };

    function load(){
      const raw = localStorage.getItem(LS_KEY);
      if(raw){
        Object.assign(state, JSON.parse(raw));
      }else{
        state.categories = [...DEFAULT_CATEGORIES];
        state.currencies = [...DEFAULT_CURRENCIES];
        state.books = {};
        state.currencies.forEach(c=> state.books[c]={ balance:0, tx:[] });
        save();
      }
    }
    function save(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      refreshAllUI();
    }

    function refreshAllUI(){
      fillCurrencies();
      fillCategories();
      updateBalanceViews();
      renderCategoryList();
      renderCurrencyList();
      renderRecords();
      renderAnalysis();
    }

    function fillCurrencies(){
      const selects = ["currencySpend","currencyBalance","currencyTopup","currencyQuick","currencyRecords","currencyAnalysis"]
        .map(id=>document.getElementById(id));
      selects.forEach(sel=>{
        const current = sel.value;
        sel.innerHTML = "";
        state.currencies.forEach(c=>{
          const opt = document.createElement("option");
          opt.value = c; opt.textContent = c;
          sel.appendChild(opt);
        });
        if(state.currencies.includes(current)) sel.value = current;
      });
    }

    function fillCategories(){
      const sel = $("#category");
      const current = sel.value;
      sel.innerHTML = "";
      state.categories.forEach(cat=>{
        const opt = document.createElement("option");
        opt.value = cat; opt.textContent = cat;
        sel.appendChild(opt);
      });
      if(state.categories.includes(current)) sel.value = current;
    }

    function getSelectedCurrency(id){
      return document.getElementById(id).value || state.currencies[0];
    }

    function fmt(n, cur){
      const val = Number(n||0);
      return `${cur} ${val.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}`;
    }

    function updateBalanceViews(){
      const c1 = getSelectedCurrency("currencyBalance");
      const c2 = getSelectedCurrency("currencyQuick");
      const b1 = state.books[c1]?.balance ?? 0;
      const b2 = state.books[c2]?.balance ?? 0;

      const box = $("#balanceBox");
      $("#balanceNum").textContent = fmt(b1, c1);
      box.classList.toggle("negative", b1 < 0);
      $("#negNotice").style.display = b1 < 0 ? "" : "none";

      $("#quickBalanceNum").textContent = fmt(b2, c2);
    }

    function addSpend(){
      const currency = getSelectedCurrency("currencySpend");
      const category = $("#category").value.trim();
      const name = $("#name").value.trim();
      const amount = parseFloat($("#amount").value);

      if(!currency){ alert("è«‹å…ˆé¸æ“‡å¹£ç¨®"); return; }
      if(!category){ alert("è«‹é¸æ“‡é¡åˆ¥"); return; }
      if(!name){ alert("è«‹è¼¸å…¥åç¨±"); return; }
      if(!(amount>0)){ alert("é‡‘é¡éœ€ç‚ºæ­£æ•¸"); return; }

      const book = state.books[currency] || (state.books[currency]={ balance:0, tx:[] });
      book.tx.push({
        id: crypto.randomUUID(),
        type: "spend",
        ts: Date.now(),
        currency,
        category,
        name,
        amount
      });
      book.balance -= amount;

      save();
      $("#name").value = "";
      $("#amount").value = "";
      alert(book.balance < 0 ? "å·²åŠ å…¥èŠ±è²»ã€‚æé†’ï¼šè³‡é‡‘æ± ç‚ºè² æ•¸ï¼Œè¨˜å¾—æ¹ŠéŒ¢ï¼" : "å·²åŠ å…¥èŠ±è²»ï¼");
    }

    function addTopup(){
      const currency = getSelectedCurrency("currencyTopup");
      const amount = parseFloat($("#topupAmount").value);
      const note = $("#topupNote").value.trim();

      if(!currency){ alert("è«‹å…ˆé¸æ“‡å¹£ç¨®"); return; }
      if(!(amount>0)){ alert("é‡‘é¡éœ€ç‚ºæ­£æ•¸"); return; }

      const book = state.books[currency] || (state.books[currency]={ balance:0, tx:[] });
      book.tx.push({
        id: crypto.randomUUID(),
        type: "topup",
        ts: Date.now(),
        currency,
        category: "æ¹ŠéŒ¢",
        name: note || "æ¹ŠéŒ¢åŠ å€¼",
        amount
      });
      book.balance += amount;

      save();
      $("#topupAmount").value = "";
      $("#topupNote").value = "";
      alert("å·²åŠ å…¥æ¹ŠéŒ¢ï¼");
    }

    function renderRecords(){
      const cur = getSelectedCurrency("currencyRecords");
      const month = $("#recordsMonth").value; // yyyy-mm
      const type = $("#recordsType").value;
      const list = $("#recordsList");
      list.innerHTML = "";

      const book = state.books[cur];
      if(!book){ list.innerHTML = "<div class='helper'>å°šç„¡ç´€éŒ„</div>"; return; }

      let tx = [...book.tx].sort((a,b)=>b.ts-a.ts);
      if(month){
        tx = tx.filter(t=>{
          const d = new Date(t.ts);
          const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          return ym===month;
        });
      }
      if(type!=="all") tx = tx.filter(t=>t.type===type);

      if(tx.length===0){ list.innerHTML = "<div class='helper'>æ­¤æ¢ä»¶ä¸‹æ²’æœ‰ç´€éŒ„</div>"; return; }

      tx.forEach(t=>{
        const d = new Date(t.ts);
        const date = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        const el = document.createElement("div");
        el.className="item";
        el.innerHTML = `
          <div>
            <div><span class="pill">${t.type==="spend"?"èŠ±è²»":"æ¹ŠéŒ¢"}</span> ${t.name || ""}</div>
            <div class="meta">${t.category} ãƒ» ${date}</div>
          </div>
          <div class="amt" style="color:${t.type==="spend"?"#ef4444":"#16a34a"}">${fmt(t.amount, cur)}</div>
        `;
        list.appendChild(el);
      });
    }

    function renderAnalysis(){
      const cur = getSelectedCurrency("currencyAnalysis");
      const month = $("#analysisMonth").value;
      const box = $("#analysisBox");
      const chart = $("#chart");
      chart.innerHTML = "";

      const book = state.books[cur];
      if(!book){ box.style.display="none"; return; }
      box.style.display="";

      let tx = book.tx.filter(t=>t.type==="spend");
      if(month){
        tx = tx.filter(t=>{
          const d = new Date(t.ts);
          const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          return ym===month;
        });
      }

      const sum = tx.reduce((s,t)=>s+t.amount,0);
      $("#sumTotal").textContent = fmt(sum, cur);

      // å¹³å‡æ¯æ—¥ï¼šä»¥è©²æœˆä»½å¯¦éš›å‡ºç¾çš„æ—¥æœŸæ•¸è¨ˆç®—
      let days=0;
      if(tx.length>0){
        const set = new Set(tx.map(t=> new Date(t.ts).getDate()));
        days = set.size;
      }
      const avg = days? (sum/days):0;
      $("#avgPerDay").textContent = fmt(avg, cur);

      // æŒ‰é¡åˆ¥åŒ¯ç¸½
      const byCat = {};
      tx.forEach(t=> byCat[t.category]=(byCat[t.category]||0)+t.amount);
      const sorted = Object.entries(byCat).sort((a,b)=>b[1]-a[1]);

      // Top 3 é¡åˆ¥
      const top3 = sorted.slice(0,3).map(([k,v])=>`${k} ${v.toFixed(0)}`).join("ã€") || "â€”";
      $("#top3").textContent = top3;

      // ç¹ªè£½ç°¡æ˜“é•·æ¢åœ–ï¼ˆç›¸å°å€¼ï¼‰
      const max = Math.max(1, ...sorted.map(x=>x[1]));
      sorted.forEach(([k,v])=>{
        const bar = document.createElement("div");
        bar.className = "bar";
        bar.style.height = `${Math.max(6, Math.round(v/max*160))}px`;
        bar.title = `${k}ï¼š${fmt(v, cur)}`;
        const lab = document.createElement("label");
        lab.textContent = k;
        bar.appendChild(lab);
        chart.appendChild(bar);
      });
    }

    function renderCategoryList(){
      const box = $("#categoryList");
      box.innerHTML = "";
      state.categories.forEach(cat=>{
        const el = document.createElement("div");
        el.className="item";
        el.innerHTML = `<div>${cat}</div><div><button class="btn ghost tiny-btn" data-del-cat="${cat}">åˆªé™¤</button></div>`;
        box.appendChild(el);
      });
      box.querySelectorAll("[data-del-cat]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const cat = btn.getAttribute("data-del-cat");
          if(!confirm(`ç¢ºå®šåˆªé™¤é¡åˆ¥ã€Œ${cat}ã€å—ï¼Ÿï¼ˆä¸æœƒåˆªé™¤æ­·å²ç´€éŒ„ï¼‰`)) return;
          state.categories = state.categories.filter(c=>c!==cat);
          save();
        });
      });
    }

    function renderCurrencyList(){
      const box = $("#currencyList");
      box.innerHTML = "";
      state.currencies.forEach(cur=>{
        const el = document.createElement("div");
        el.className="item";
        el.innerHTML = `<div>${cur}</div><div><button class="btn ghost tiny-btn" data-del-cur="${cur}">åˆªé™¤</button></div>`;
        box.appendChild(el);
      });
      box.querySelectorAll("[data-del-cur]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const cur = btn.getAttribute("data-del-cur");
          if(!confirm(`ç¢ºå®šåˆªé™¤å¹£ç¨®ã€Œ${cur}ã€å—ï¼Ÿï¼ˆå°‡åŒæ™‚åˆªé™¤è©²å¹£ç¨®è³‡é‡‘æ± èˆ‡ç´€éŒ„ï¼‰`)) return;
          state.currencies = state.currencies.filter(c=>c!==cur);
          delete state.books[cur];
          save();
        });
      });
    }

    // äº‹ä»¶ç¹«çµ
    function bind(){
      // æ¨™ç±¤åˆ‡æ›
      $$("#tabs .tab").forEach(t=>{
        t.addEventListener("click", ()=>{
          $$("#tabs .tab").forEach(x=>x.classList.remove("active"));
          t.classList.add("active");
          const tab = t.getAttribute("data-tab");
          $$(".view").forEach(v=> v.style.display = (v.id===tab)?"":"none");
          if(tab==="spend"||tab==="topup") updateBalanceViews();
          if(tab==="records") renderRecords();
          if(tab==="analysis") renderAnalysis();
        });
      });

      // é¸å–®äº‹ä»¶
      ["currencyBalance","currencyQuick"].forEach(id=>{
        document.getElementById(id).addEventListener("change", updateBalanceViews);
      });
      ["currencyRecords","recordsMonth","recordsType"].forEach(id=>{
        document.getElementById(id).addEventListener("change", renderRecords);
      });
      ["currencyAnalysis","analysisMonth"].forEach(id=>{
        document.getElementById(id).addEventListener("change", renderAnalysis);
      });

      // åŠŸèƒ½æŒ‰éˆ•
      $("#addSpend").addEventListener("click", addSpend);
      $("#addTopup").addEventListener("click", addTopup);
      $("#addCategoryBtn").addEventListener("click", ()=>{
        const name = prompt("è¼¸å…¥æ–°é¡åˆ¥åç¨±ï¼š")?.trim();
        if(!name) return;
        if(state.categories.includes(name)){ alert("æ­¤é¡åˆ¥å·²å­˜åœ¨"); return; }
        state.categories.push(name);
        save();
      });

      // è¨­å®šï¼æ–°å¢
      $("#saveCategory").addEventListener("click", ()=>{
        const name = $("#newCategoryName").value.trim();
        if(!name){ alert("è«‹è¼¸å…¥é¡åˆ¥åç¨±"); return; }
        if(state.categories.includes(name)){ alert("æ­¤é¡åˆ¥å·²å­˜åœ¨"); return; }
        state.categories.push(name);
        $("#newCategoryName").value="";
        save();
      });
      $("#saveCurrency").addEventListener("click", ()=>{
        const code = $("#newCurrencyCode").value.trim().toUpperCase();
        if(!code){ alert("è«‹è¼¸å…¥å¹£ç¨®ä»£ç¢¼"); return; }
        if(state.currencies.includes(code)){ alert("æ­¤å¹£ç¨®å·²å­˜åœ¨"); return; }
        state.currencies.push(code);
        state.books[code] = { balance:0, tx:[] };
        $("#newCurrencyCode").value="";
        save();
      });

      // å‚™ä»½
      $("#exportBtn").addEventListener("click", ()=>{
        const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        const now = new Date();
        const ts = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        a.download = `couple-ledger-${ts}.json`;
        a.click();
      });
      $("#importBtn").addEventListener("click", ()=> $("#importFile").click());
      $("#importFile").addEventListener("change", (e)=>{
        const file = e.target.files[0]; if(!file) return;
        const fr = new FileReader();
        fr.onload = ()=>{
          try{
            const data = JSON.parse(fr.result);
            if(!confirm("åŒ¯å…¥å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ï¼Œç¢ºå®šè¦åŒ¯å…¥å—ï¼Ÿ")) return;
            localStorage.setItem(LS_KEY, JSON.stringify(data));
            location.reload();
          }catch(err){
            alert("åŒ¯å…¥å¤±æ•—ï¼šä¸æ˜¯æœ‰æ•ˆçš„ JSON æª”");
          }
        };
        fr.readAsText(file);
      });
      $("#resetBtn").addEventListener("click", ()=>{
        if(!confirm("ç¢ºå®šæ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•é‚„åŸã€‚")) return;
        localStorage.removeItem(LS_KEY);
        location.reload();
      });

      // åˆå§‹åŒ–æœˆä»½ç‚ºæœ¬æœˆ
      const mm = `${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}`;
      const monthInputs = ["recordsMonth","analysisMonth"];
      monthInputs.forEach(id=>{
        const el = document.getElementById(id);
        el.value = mm;
      });
    }

    // å•Ÿå‹•
    load();
    bind();
    refreshAllUI();
  </script>
</body>
</html>
